<!DOCTYPE html>
<html>

<head>
  <title>Address autocomplete</title>
  <script type="text/javascript" src="//js.jotform.com/JotFormCustomWidget.min.js"></script>

</head>

<body>
  <input id="autocomplete" placeholder="Enter your address" type="text" style="width:95%" />
  <script>
    function buildAutocompleteConfig() {
      var config = {}
      if (window.options.restrictCountry) {
        config.componentRestrictions = { country: window.options.restrictCountry };
      }

      if (window.options.biasLocation) {
        config.location = new google.maps.LatLng(window.options.biasLocation)
      }
      config.fields = ["formatted_address", "geometry"];

      // if (window.options.biasBounds) {
      //   config.bounds = new google.maps.LatLng(window.options.biasBounds)
      // }
      console.log(window.options, 'CONFIG', config)
    }

    function googleReady() {
      var autocomplete = new google.maps.places.Autocomplete(
        document.getElementById("autocomplete"),
        buildAutocompleteConfig(),
      );

      autocomplete.addListener("place_changed", function () {
        var place = autocomplete.getPlace();
        console.log('PLACE', place)
        var address = place.formatted_address;
        var lat = place.geometry.location.lat();
        var lng = place.geometry.location.lng();
        // const place_id = place.place_id
        window.autocompleteValid = true;
        // window.autocompleteValue = 'lat: ' + lat + ' lng: ' + lng + ' address: ' + address;
        window.autocompleteValue = '{ lat: ' + lat + ', lng: ' + lng + ', address: "' + address + '" }';

        console.log(window.autocompleteValue)
        JFCustomWidget.sendData(window.autocompleteValue)
      });

    }

    JFCustomWidget.subscribe("ready", function (msg) {
      // Indicates to Jotform that that a valid address has been matched
      window.autocompleteValid = false;
      // Final return address/coords
      window.autocompleteValue = ''

      // Gets api key from Jotform then initialises gmaps script
      var placesApiKey = JFCustomWidget.getWidgetSetting('placesApiKey');

      var script = document.createElement('script');
      script.src = 'https://maps.googleapis.com/maps/api/js?key=' + placesApiKey + '&libraries=places&callback=googleReady';
      script.async = false;
      document.head.appendChild(script);

      var options = {}

      // Get other config settings from Jotform
      options.includeCoords = JFCustomWidget.getWidgetSetting('includeCoords') === 'true'
      options.formatAsObject = JFCustomWidget.getWidgetSetting('formatAsObject') === 'true'
      options.restrictCountry = JFCustomWidget.getWidgetSetting('restrictCountry')
      options.biasLocation = JFCustomWidget.getWidgetSetting('biasLocation')
      options.biasBoundsNE = JFCustomWidget.getWidgetSetting('biasBoundsNE')
      options.biasBoundsSW = JFCustomWidget.getWidgetSetting('biasBoundsSW')

      window.options = options;


    })

    JFCustomWidget.subscribe("submit", function () {
      var data = { valid: false };
      if (window.autocompleteValid) {
        data.valid = true
        data.value = window.autocompleteValue
      }
      JFCustomWidget.sendSubmit(data);
    });

  </script>
</body>

</html>
